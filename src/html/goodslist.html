<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>商品列表</title>
		<link rel="stylesheet" href="../layui-v2.4.5/layui/css/layui.css">
		<script type="text/javascript" src="../layui-v2.4.5/layui/layui.js"></script>
		<style type="text/css">
			.demo-carousel {
				height: 200px;
				line-height: 200px;
				text-align: center;
			}
		</style>
	</head>

	<body class="layui-layout-body">
		<div class="layui-layout layui-layout-admin">
			<!--头部-->
			<div class="layui-header">
				<div class="layui-logo">电商后台管理系统</div>
				<!-- 头部区域（可配合layui已有的水平导航） -->
				<ul class="layui-nav layui-layout-left">
					<!--<li class="layui-nav-item">
						<a href="">控制台</a>
					</li>-->
					<li class="layui-nav-item">
						<a href="goodslist.html">商品管理</a>
					</li>
					<li class="layui-nav-item">
						<a href="userlist.html">用户</a>
					</li>
					<li class="layui-nav-item">
						<a href="orderlist.html">订单</a>
					</li>
				</ul>
				<ul class="layui-nav layui-layout-right">
					<li class="layui-nav-item">
						<a href="javascript:;">
							<img src="http://t.cn/RCzsdCq" class="layui-nav-img"> 贤心
						</a>
						<dl class="layui-nav-child">
							<dd>
								<a href="">基本资料</a>
							</dd>
						</dl>
					</li>
					<li class="layui-nav-item">
						<a href="">退了</a>
					</li>
				</ul>
			</div>

			<!--左侧栏-->
			<div class="layui-side layui-bg-black">
				<div class="layui-side-scroll">
					<!-- 左侧导航区域（可配合layui已有的垂直导航） -->
					<ul class="layui-nav layui-nav-tree" lay-filter="test">
						<li class="layui-nav-item layui-nav-itemed">
							<a class="" href="javascript:;">所有商品</a>
							<dl class="layui-nav-child">
								<dd>
									<a href="goodslist.html">商品列表</a>
								</dd>
							</dl>
						</li>
						<li class="layui-nav-item">
							<a href="javascript:;">用户管理</a>
							<dl class="layui-nav-child">
								<dd>
									<a href="userlist.html">用户列表</a>
								</dd>
							</dl>
						</li>
						<li class="layui-nav-item">
							<a href="javascript:;">订单管理</a>
							<dl class="layui-nav-child">
								<dd>
									<a href="orderlist.html">订单列表</a>
								</dd>
							</dl>
						</li>
					</ul>
				</div>
			</div>
			<!--内容主题-->
			<div class="layui-body">
				<div style="padding: 15px;">
					<table class="layui-hide" id="demo" lay-filter="test"></table>

					<script type="text/html" id="barDemo">
						<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
						<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
						<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
					</script>
				</div>
			</div>

			<div class="layui-footer">
				<!-- 底部固定区域 -->
			</div>
		</div>
		<!--<script src="../layui-v2.4.5/layui/layui.js"></script>-->
		<script>
			//JavaScript代码区域
			layui.use('element', function() {
				var element = layui.element;
			});
			layui.use(['laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element', 'slider'], function() {
				var laydate = layui.laydate //日期
					,
					laypage = layui.laypage //分页
					,
					layer = layui.layer //弹层
					,
					table = layui.table //表格
					,
					carousel = layui.carousel //轮播
					,
					upload = layui.upload //上传
					,
					element = layui.element //元素操作
					,
					slider = layui.slider //滑块

				//执行一个 table 实例
				table.render({
					elem: '#demo',
					height: 420,
					url: '/goods' //数据接口
						,
					title: '商品表',
					page: true //开启分页
						,
					toolbar: 'default' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
						,
					cols: [
						[ //表头
							{
								type: 'checkbox',
								fixed: 'left'
							}, {
								field: 'goodsname',
								title: '商品名',
								align: 'center',
								width: 220
							}, {
								field: 'nowprice',
								title: '现价',
								width: 150,
								align: 'center',
								sort: true
							}, {
								field: 'oldprice',
								title: '原价',
								width: 200,
								align: 'center',
								sort: true
							}, {
								field: 'number',
								title: '库存',
								align: 'center',
								width: 150
							}, {
								field: 'goodsclass',
								title: '类别',
								align: 'center',
								width: 150
							}, {
								field: 'close',
								title: '上架',
								align: 'center',
								width: 130
							}, {
								fixed: 'right',
								width: 230,
								align: 'center',
								toolbar: '#barDemo'
							}
						]
					]
				});

				//监听头工具栏事件
				table.on('toolbar(test)', function(obj) {
					var checkStatus = table.checkStatus(obj.config.id),
						data = checkStatus.data; //获取选中的数据
					switch(obj.event) {
						case 'add':
							//							layer.msg('添加');
							location.href = 'addgoods.html';
							break;
						case 'update':
							if(data.length === 0) {
								layer.msg('请选择一行');
							} else if(data.length > 1) {
								layer.msg('只能同时编辑一个');
							} else {
								location.href = 'changegoods.html?_id='+checkStatus.data[0]._id;
							}
							break;
						case 'delete':
							if(data.length === 0) {
								layer.msg('请选择一行');
							} else {
								layer.confirm('真的删除么', function(index) {
									layer.close(index);
									let idarr = [];
									for(let i = 0; i < checkStatus.data.length; i++)
										idarr.push(checkStatus.data[i]._id)
									deleteg(idarr);
									location.reload();
								});
							}
							break;
					};
				});

				//监听行工具事件
				table.on('tool(test)', function(obj) { //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
					var data = obj.data //获得当前行数据
						,
						layEvent = obj.event //获得 lay-event 对应的值
					if(layEvent === 'detail') {
						location.href='watchgoods.html?_id='+obj.data._id;
					} else if(layEvent === 'del') {
						layer.confirm('真的删除行么', function(index) {
							obj.del(); //删除对应行（tr）的DOM结构
							layer.close(index);
							//向服务端发送删除指令
							let idarr = [];
							idarr.push(obj.data._id)
							deleteg(idarr);
						});
					} else if(layEvent === 'edit') {
						location.href = 'changegoods.html?_id='+obj.data._id;
					}
				});
				//分页
				laypage.render({
					elem: 'pageDemo' //分页容器的id
						,
					count: 100 //总页数
						,
					skin: '#1E9FFF' //自定义选中色值
						//,skip: true //开启跳页
						,
					jump: function(obj, first) {
						if(!first) {
							layer.msg('第' + obj.curr + '页', {
								offset: 'b'
							});
						}
					}
				});
			});

			function deleteg(gid) {
				let xhr = new XMLHttpRequest();
				
				xhr.open('POST', '/deletegoods', true);
				xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				xhr.send('colname=goods&_id=' + gid);
			}
		</script>
	</body>

</html>